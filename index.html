<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1 SIDE LüíóVEüòò - Firebase Ready</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom Styles for aesthetics and mobile */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            touch-action: pan-y;
        }
        #app-container {
            max-width: 420px;
            min-height: 100vh;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .nav-icon {
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon.active {
            color: #ff3864; /* Pink for active tab */
        }
        .scroll-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 64px; /* Space for the footer nav */
            -webkit-overflow-scrolling: touch;
        }
        .chat-bubble {
            max-width: 80%;
            border-radius: 1.5rem;
            padding: 0.6rem 1rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .my-message {
            margin-left: auto;
            background-color: var(--primary-color, #ff3864); /* Premium/Default Color */
            color: white;
            border-bottom-right-radius: 0.5rem;
        }
        .other-message {
            margin-right: auto;
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0.5rem;
        }
    </style>
</head>
<body>

<div id="app-container" class="relative">
    <div id="loading-screen" class="absolute inset-0 bg-pink-100 flex flex-col justify-center items-center z-50 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-pink-500 border-t-white"></div>
        <p class="mt-4 text-pink-700 font-semibold">‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... (Firebase ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à)</p>
    </div>

    <div id="auth-view" class="p-6 pt-16 flex flex-col items-center justify-center min-h-screen hidden">
        <!-- Auth Content goes here (Login/Signup) -->
    </div>

    <div id="app-content" class="flex-grow flex flex-col hidden">
        <!-- Header -->
        <header id="header-container" class="sticky top-0 bg-white border-b border-gray-100 shadow-sm p-4 flex justify-between items-center z-10">
            <h1 class="text-xl font-bold text-gray-800">1 SIDE LüíóVEüòò</h1>
            <div id="header-actions">
                <!-- Action buttons based on view -->
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="main-view" class="scroll-container flex-grow">
            <!-- Dynamic Content (Feed, Messages, Profile, etc.) will be injected here -->
        </div>

        <!-- Footer Navigation -->
        <footer id="footer-nav" class="sticky bottom-0 bg-white border-t border-gray-100 flex justify-around p-3 z-20">
            <!-- Icons will be injected here -->
        </footer>
    </div>
    
    <!-- Modal Container for Followers/Following/Help -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-md max-h-[80%] overflow-y-auto">
            <!-- Modal Content Injected Here -->
        </div>
    </div>
    
    <!-- Custom Alert for Notifications -->
    <div id="custom-alert" class="fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 opacity-0 z-[100] max-w-[90%]"></div>
</div>

<script type="module">
    // --- Firebase SDKs Import ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Firebase Configuration ---
    // !!! IMPORTANT !!!: ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è placeholders ‡§ï‡•ã ‡§Ö‡§™‡§®‡•Ä ‡§Ö‡§∏‡§≤‡•Ä Firebase Details ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç
    // ‡§Ü‡§™‡§®‡•á ‡§á‡§®‡•ç‡§π‡•á‡§Ç Firebase Console ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§•‡§æ‡•§
    const firebaseConfig = {
      apiKey: "AIzaSyDBwmpeqC8xKA0YwVFKdf...", 
      authDomain: "side-love-3a293.firebaseapp.com", 
      projectId: "side-love-3a293", 
      storageBucket: "side-love-3a293.appspot.com",
      messagingSenderId: "460469284994",
      appId: "1:460469284994:web:14c03e0f4..."
      // measurementId: "G-GFL94RCDVW" // ‡§á‡§∏‡•á ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï (Optional) ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§õ‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
    };

    let app, db, auth;
    let currentUserId = null;
    let currentUserData = null;
    let currentView = 'feed'; // Default view
    let allUsersCache = []; // Cache for user data
    let unsubscribeListeners = []; // Array to hold all real-time unsubscribe functions

    // --- Utility Functions ---
    const qs = (selector) => document.querySelector(selector);
    const qsa = (selector) => document.querySelectorAll(selector);

    const showView = (viewName) => {
        currentView = viewName;
        renderApp();
    };

    // Note: Since this is a public app, all data is in the public collection path
    const getPublicCollectionPath = (collectionName) => {
         // __app_id is automatically provided by the platform, but we use a default for deployment safety
         const appId = 'one-side-love'; 
         return `artifacts/${appId}/public/data/${collectionName}`;
    };

    const getPublicDocPath = (collectionName, docId) => {
        return doc(db, getPublicCollectionPath(collectionName), docId);
    };

    const getAvatarUrl = (photoURL) => {
        return photoURL || 'https://placehold.co/100x100/fecaca/9f1239?text=Love';
    }

    function calculateLevelAndCrown(xp) {
        let level = 1;
        let crown = 'No Crown';

        if (xp >= 100) { level = 5; crown = 'Diamond Crown üíé'; }
        else if (xp >= 60) { level = 4; crown = 'Gold Crown ü•á'; }
        else if (xp >= 30) { level = 3; crown = 'Silver Crown ü•à'; }
        else if (xp >= 10) { level = 2; crown = 'Bronze Crown ü•â'; }

        return { level, crown };
    }
    
    // --- Authentication and Initialization ---

    /**
     * Attempts to initialize Firebase and authenticate the user.
     */
    async function initializeAppAndAuth() {
        qs('#loading-screen').classList.remove('hidden');

        try {
            // Firebase Services ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                qs('#loading-screen').classList.add('hidden');
                
                if (user) {
                    currentUserId = user.uid;
                    await loadUserProfile(); // ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ Firestore ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•ã‡§ó‡•Ä
                    setupRealtimeListeners(); // Firestore ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                    renderApp(); // App UI ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
                } else {
                    currentUserId = null;
                    // ‡§Ö‡§ó‡§∞ ‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§π‡•à, ‡§§‡•ã AuthView ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
                    unsubscribeListeners.forEach(unsub => unsub()); // ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§π‡§ü‡§æ‡§è‡§Å
                    unsubscribeListeners = [];
                    qs('#app-content').classList.add('hidden');
                    qs('#auth-view').classList.remove('hidden');
                    renderAuthView('login');
                }
            });
            
        } catch (error) {
            console.error("Firebase Initialization or Auth Failed:", error);
            qs('#loading-screen').innerHTML = `<p class="text-red-600 font-semibold">Error: Firebase ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§ ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç‡•§</p>`;
        }
    }

    /**
     * Loads the user profile from a public collection path based on UID.
     */
    async function loadUserProfile() {
        if (!currentUserId) return;
        try {
            const userDocRef = getPublicDocPath('users', currentUserId);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
            } else {
                // Initialize new user profile
                currentUserData = {
                    uid: currentUserId,
                    username: `User_${Math.random().toString(36).substring(7)}`,
                    email: auth.currentUser.email || '',
                    bio: 'Hey there! I am new to 1 SIDE LüíóVEüòò.',
                    photoURL: '',
                    isPremium: false,
                    isPublic: true,
                    xp: 0,
                    followers: [], 
                    following: [], 
                    chatTheme: '#ff3864',
                    chatBackground: '',
                    createdAt: Date.now()
                };
                await setDoc(userDocRef, currentUserData);
            }
        } catch (error) {
            console.error("Error loading user profile:", error);
            currentUserData = null; 
        }
    }
    
    /**
     * Fetches and caches all user data.
     */
    async function fetchAllUsers() {
        try {
            const q = query(collection(db, getPublicCollectionPath('users')));
            const querySnapshot = await getDocs(q);
            allUsersCache = querySnapshot.docs.map(doc => doc.data());
        } catch (error) {
            console.error("Error fetching all users:", error);
        }
    }

    // --- Realtime Listeners ---

    function setupRealtimeListeners() {
        // 1. Listen for User Profile changes (for real-time XP/Premium updates)
        const userDocRef = getPublicDocPath('users', currentUserId);
        const unsubUser = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                if (currentView === 'profile' || currentView === 'settings') renderApp(); 
            }
        });
        unsubscribeListeners.push(unsubUser);


        // 2. Listen for Posts 
        const postsRef = collection(db, getPublicCollectionPath('posts'));
        const unsubPosts = onSnapshot(postsRef, async (snapshot) => {
            await fetchAllUsers(); // Refresh users when posts update (to get updated crowns)
            if (currentView === 'feed') renderFeedView(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        unsubscribeListeners.push(unsubPosts);
        
        // 3. Listen for Rooms (Public collection)
        const roomsRef = collection(db, getPublicCollectionPath('rooms'));
        const unsubRooms = onSnapshot(roomsRef, (snapshot) => {
            roomsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentView === 'messages') renderMessagesView();
            // Note: Chat messages are handled by a separate listener inside renderChatView
        });
        unsubscribeListeners.push(unsubRooms);
        
        // 4. Listen for User changes (to update discover view)
        const usersRef = collection(db, getPublicCollectionPath('users'));
        const unsubAllUsers = onSnapshot(usersRef, (snapshot) => {
            allUsersCache = snapshot.docs.map(doc => doc.data());
            if (currentView === 'users') renderUsersView();
            if (currentView.startsWith('chat-')) renderChatView(currentView.substring(5)); // Update chat headers/avatars
        });
        unsubscribeListeners.push(unsubAllUsers);
    }

    // --- Render Functions (Views) ---

    // =======================================================================
    // 1. AUTH VIEW (Login/Signup Simulation)
    // =======================================================================

    const renderAuthView = (mode) => {
        const container = qs('#auth-view');
        container.classList.remove('hidden');
        qs('#app-content').classList.add('hidden');
        
        container.innerHTML = `
            <div class="w-full max-w-xs p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-3xl font-extrabold text-center text-pink-600 mb-6">
                    ${mode === 'login' ? '‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç' : '‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç'}
                </h2>
                <p class="text-sm text-center text-gray-500 mb-4">Firebase Authentication ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§</p>
                <form id="${mode}-form">
                    ${mode === 'signup' ? `
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700" for="username">‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ</label>
                            <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700" for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="text" id="mobile" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                    ` : ''}
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700" for="email">Gmail ID</label>
                        <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700" for="password">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" class="w-full mt-4 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        ${mode === 'login' ? '‡§≤‡•â‡§ó ‡§á‡§®' : '‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç'}
                    </button>
                </form>
                <button id="switch-auth-mode" class="w-full mt-4 text-sm text-pink-600 hover:text-pink-800">
                    ${mode === 'login' ? '‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç' : '‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§π‡•à? ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç'}
                </button>
            </div>
        `;

        // Add event listeners for forms
        qs(`#${mode}-form`).addEventListener('submit', (e) => {
            e.preventDefault();
            const email = qs('#email').value;
            const password = qs('#password').value;
            const errorElement = qs('#auth-error');
            errorElement.classList.add('hidden');

            if (mode === 'signup') {
                handleSignup(email, password, qs('#username').value, qs('#mobile').value);
            } else {
                handleLogin(email, password);
            }
        });

        qs('#switch-auth-mode').addEventListener('click', () => {
            renderAuthView(mode === 'login' ? 'signup' : 'login');
        });
    }

    async function handleLogin(email, password) {
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // AuthStateChanged listener handles the rest
        } catch (error) {
            console.error("Login Failed:", error);
            const errorElement = qs('#auth-error');
            errorElement.textContent = `Login failed: ${error.message}`;
            errorElement.classList.remove('hidden');
        }
    }

    async function handleSignup(email, password, username, mobile) {
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Step 2: Update the public user profile with sign-up details
            const userDocRef = getPublicDocPath('users', userCredential.user.uid);
            await setDoc(userDocRef, {
                uid: userCredential.user.uid,
                username,
                email,
                mobile,
                bio: 'Hey there! I am new to 1 SIDE LüíóVEüòò.',
                photoURL: '',
                isPremium: false,
                isPublic: true,
                xp: 0,
                followers: [],
                following: [],
                chatTheme: '#ff3864',
                chatBackground: '',
                createdAt: Date.now()
            });

            // Step 3: Simulate mobile verification code (Fixed code: 0123)
            // Note: Real Firebase Phone Auth needs Recaptcha, which is skipped here.
            await promptMobileVerification();

            // AuthStateChanged listener handles the rest
        } catch (error) {
            console.error("Signup Failed:", error);
            const errorElement = qs('#auth-error');
            errorElement.textContent = `Signup failed: ${error.message}`;
            errorElement.classList.remove('hidden');
        }
    }

    async function promptMobileVerification() {
        return new Promise((resolve) => {
            const modal = createModal('‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§µ‡•á‡§∞‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§®', `
                <p class="mb-4 text-gray-600">‡§Ü‡§™‡§ï‡•á ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ 4 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ (‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§∂‡§® ‡§ï‡•ã‡§°: <span class="font-bold text-pink-600">0123</span>)</p>
                <input type="text" id="verification-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 text-center text-lg" maxlength="4" placeholder="XXXX">
                <p id="code-error" class="text-red-500 text-sm mt-2 hidden">‡§ó‡§≤‡§§ ‡§ï‡•ã‡§°‡•§</p>
                <button id="verify-btn" class="w-full mt-4 py-2 px-4 rounded-lg shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700">‡§µ‡•á‡§∞‡•Ä‡§´‡§æ‡§à ‡§ï‡§∞‡•á‡§Ç</button>
            `);

            qs('#verify-btn').addEventListener('click', () => {
                const code = qs('#verification-code').value;
                if (code === '0123') {
                    closeModal();
                    resolve();
                } else {
                    qs('#code-error').classList.remove('hidden');
                }
            });
        });
    }

    // =======================================================================
    // 2. FEED VIEW
    // =======================================================================

    const renderFeedView = (posts = []) => {
        const mainView = qs('#main-view');
        mainView.innerHTML = `<div class="p-4 space-y-6" id="posts-list"></div>`;

        qs('#header-actions').innerHTML = `
            <button id="open-post-modal" class="p-2 text-pink-600 hover:text-pink-800 rounded-full">
                ${lucide.createAIcon('PlusSquare', 'w-6 h-6').toSvg()}
            </button>
        `;
        qs('#open-post-modal').addEventListener('click', renderPostModal);

        const postsList = qs('#posts-list');
  
