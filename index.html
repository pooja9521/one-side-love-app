// --- Firebase SDKs Import ---
// NOTE: For a real app, use the module imports, as shown below.
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Configuration ---
// IMPORTANT: ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è placeholders ‡§ï‡•ã ‡§Ö‡§™‡§®‡•Ä ‡§Ö‡§∏‡§≤‡•Ä Firebase Details ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE", 
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // ‡§â‡§¶‡§æ‡§π‡§∞‡§£: side-love-3a293.firebaseapp.com
  projectId: "YOUR_PROJECT_ID", // ‡§â‡§¶‡§æ‡§π‡§∞‡§£: side-love-3a293
  storageBucket: "YOUR_STORAGE_BUCKET_HERE.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID_HERE",
  appId: "YOUR_APP_ID_HERE"
  // measurementId: "G-GFL94RCDVW" // ‡§á‡§∏‡•á ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï (Optional) ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§õ‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
};

let app, db, auth;
let currentUserId = null;
let currentUserData = null;
let currentView = 'feed'; 
let allUsersCache = []; // Real-time users will be fetched from Firestore
let roomsCache = []; // Real-time rooms will be fetched from Firestore

// --- Initialization Function (App Start) ---
async function initializeAppAndAuth() {
    try {
        // Firebase Services ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                await loadUserProfile(); // ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ Firestore ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•ã‡§ó‡•Ä
                setupRealtimeListeners(); // Firestore ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                renderApp(); // App UI ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
            } else {
                currentUserId = null;
                // ‡§Ö‡§ó‡§∞ ‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§π‡•à, ‡§§‡•ã AuthView ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
                qs('#app-content').classList.add('hidden');
                qs('#auth-view').classList.remove('hidden');
                renderAuthView('login');
            }
        });
        
    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        alert("‡§ê‡§™ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§"); // Fallback alert
    }
}
// ‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§æ‡§∞‡§æ ‡§ï‡•ã‡§° (‡§ú‡•à‡§∏‡•á handleLogin, renderFeedView, ‡§Ü‡§¶‡§ø) ‡§á‡§∏‡§ï‡•á ‡§®‡•Ä‡§ö‡•á ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§π‡•á‡§ó‡§æ‡•§

<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1 SIDE LüíóVEüòò - Local Storage Demo</title>
    <!-- Tailwind CSS -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- Inter Font -->
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap)" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="[https://unpkg.com/lucide@latest](https://unpkg.com/lucide@latest)"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            touch-action: pan-y;
        }
        #app-container {
            max-width: 420px;
            min-height: 100vh;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .nav-icon {
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon.active {
            color: #ff3864; 
        }
        .scroll-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 64px;
            -webkit-overflow-scrolling: touch;
        }
        .chat-bubble {
            max-width: 80%;
            border-radius: 1.5rem;
            padding: 0.6rem 1rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .my-message {
            margin-left: auto;
            background-color: var(--primary-color, #ff3864); 
            color: white;
            border-bottom-right-radius: 0.5rem;
        }
        .other-message {
            margin-right: auto;
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0.5rem;
        }
    </style>
</head>
<body>

<div id="app-container" class="relative">
    <div id="loading-screen" class="absolute inset-0 bg-pink-100 flex flex-col justify-center items-center z-50 transition-opacity duration-300 hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-pink-500 border-t-white"></div>
        <p class="mt-4 text-pink-700 font-semibold">‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
    </div>

    <div id="auth-view" class="p-6 pt-16 flex flex-col items-center justify-center min-h-screen hidden">
    </div>

    <div id="app-content" class="flex-grow flex flex-col hidden">
        <header id="header-container" class="sticky top-0 bg-white border-b border-gray-100 shadow-sm p-4 flex justify-between items-center z-10">
            <h1 class="text-xl font-bold text-gray-800">1 SIDE LüíóVEüòò</h1>
            <div id="header-actions"></div>
        </header>

        <div id="main-view" class="scroll-container flex-grow"></div>

        <footer id="footer-nav" class="sticky bottom-0 bg-white border-t border-gray-100 flex justify-around p-3 z-20"></footer>
    </div>
    
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-md max-h-[80%] overflow-y-auto"></div>
    </div>
</div>

<script>
    let currentUserId = localStorage.getItem('currentUserId');
    let currentUserData = null;
    let currentView = 'feed';
    let allUsersCache = JSON.parse(localStorage.getItem('allUsers')) || [];

    const qs = (selector) => document.querySelector(selector);
    const qsa = (selector) => document.querySelectorAll(selector);

    const getCurrentUserProfile = () => {
        if (!currentUserId) return null;
        return allUsersCache.find(u => u.uid === currentUserId);
    };

    const saveAllUsers = (newData) => {
        allUsersCache = newData;
        localStorage.setItem('allUsers', JSON.stringify(allUsersCache));
        currentUserData = getCurrentUserProfile();
    };
    
    const updateCurrentUserProfile = (updates) => {
        const newData = allUsersCache.map(u => 
            u.uid === currentUserId ? { ...u, ...updates } : u
        );
        saveAllUsers(newData);
    };

    const getAvatarUrl = (photoURL) => {
        return photoURL || '[https://placehold.co/100x100/fecaca/9f1239?text=Love](https://placehold.co/100x100/fecaca/9f1239?text=Love)';
    }

    const showView = (viewName) => {
        currentView = viewName;
        renderApp();
    };

    function calculateLevelAndCrown(xp) {
        let level = 1;
        let crown = 'No Crown';

        if (xp >= 100) { level = 5; crown = 'Diamond Crown üíé'; }
        else if (xp >= 60) { level = 4; crown = 'Gold Crown ü•á'; }
        else if (xp >= 30) { level = 3; crown = 'Silver Crown ü•à'; }
        else if (xp >= 10) { level = 2; crown = 'Bronze Crown ü•â'; }

        return { level, crown };
    }

    function clearLocalStorageAndReset() {
        localStorage.removeItem('currentUserId');
        localStorage.removeItem('allUsers');
        localStorage.removeItem('posts');
        localStorage.removeItem('rooms');
        localStorage.removeItem('messages-room_1');
        localStorage.removeItem('messages-room_2');
        currentUserId = null;
        allUsersCache = [];
        currentUserData = null;
        initializeData(true);
        renderApp();
        showCustomAlert('‡§∏‡§´‡§≤‡§§‡§æ', '‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§π‡•Å‡§Ü! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'success');
    }

    function initializeData(force = false) {
        if (allUsersCache.length === 0 || force) {
            allUsersCache = [
                { uid: 'user_1', username: 'Priya', email: 'priya@app.com', password: 'password', bio: 'Looking for 1 SIDE LüíóVE!', photoURL: '', isPremium: true, isPublic: true, xp: 70, followers: ['user_2'], following: [], chatTheme: '#ff3864', chatBackground: '', createdAt: Date.now() },
                { uid: 'user_2', username: 'Rahul', email: 'rahul@app.com', password: 'password', bio: 'Coffee lover.', photoURL: '[https://placehold.co/100x100/808080/ffffff?text=R](https://placehold.co/100x100/808080/ffffff?text=R)', isPremium: false, isPublic: true, xp: 20, followers: ['user_1'], following: ['user_1'], chatTheme: '#ff3864', chatBackground: '', createdAt: Date.now() },
                { uid: 'user_3', username: 'Anjali', email: 'anjali@app.com', password: 'password', bio: 'My account is private.', photoURL: '[https://placehold.co/100x100/fecaca/9f1239?text=A](https://placehold.co/100x100/fecaca/9f1239?text=A)', isPremium: false, isPublic: false, xp: 5, followers: [], following: [], chatTheme: '#ff3864', chatBackground: '', createdAt: Date.now() },
            ];
            localStorage.setItem('allUsers', JSON.stringify(allUsersCache));
            
            localStorage.setItem('posts', JSON.stringify([
                { id: 'post_1', userId: 'user_1', caption: 'Today was a beautiful day. ‚òÄÔ∏è', photoURL: '[https://placehold.co/400x200/ffb8c4/9f1239?text=Happy+Story](https://placehold.co/400x200/ffb8c4/9f1239?text=Happy+Story)', likes: ['user_2'], comments: [], shares: 1, isPublic: true, createdAt: Date.now() - 50000 },
                { id: 'post_2', userId: 'user_2', caption: 'Chilling at home. Anyone up for a chat?', photoURL: '', likes: [], comments: [], shares: 0, isPublic: true, createdAt: Date.now() - 30000 },
                { id: 'post_3', userId: 'user_3', caption: 'Secret thoughts only for followers.', photoURL: '[https://placehold.co/400x200/a3e635/1f2937?text=Private+Post](https://placehold.co/400x200/a3e635/1f2937?text=Private+Post)', likes: [], comments: [], shares: 0, isPublic: false, createdAt: Date.now() - 10000 },
            ]));
            
            localStorage.setItem('rooms', JSON.stringify([
                { id: 'room_1', name: "‡§™‡§¨‡•ç‡§≤‡§ø‡§ï ‡§≤‡§µ‡§∞‡•ç‡§∏ ‡§ö‡•à‡§ü", isPremium: false, users: ['user_1', 'user_2'] },
                { id: 'room_2', name: "‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§≤ ‡§ï‡•Ä ‡§¨‡§æ‡§§‡•á‡§Ç", isPremium: true, users: ['user_1'] },
            ]));

            localStorage.setItem('messages-room_1', JSON.stringify([
                { id: 'msg1', userId: 'user_1', text: 'Hi everyone!', timestamp: Date.now() - 10000, isDeleted: false },
                { id: 'msg2', userId: 'user_2', text: 'Hello Priya!', timestamp: Date.now() - 8000, isDeleted: false },
            ]));

            localStorage.setItem('messages-room_2', JSON.stringify([
                { id: 'msg3', userId: 'user_1', text: 'Welcome to the premium room! üëë', timestamp: Date.now() - 5000, isDeleted: false },
            ]));
        }
        
        if (currentUserId) {
            currentUserData = getCurrentUserProfile();
        }
    }

    function handleLogin(email, password) {
        const user = allUsersCache.find(u => u.email === email && u.password === password);
        
        if (user) {
            currentUserId = user.uid;
            localStorage.setItem('currentUserId', currentUserId);
            currentUserData = user;
            showCustomAlert('‡§∏‡§´‡§≤‡§§‡§æ', `${user.username} ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•Å‡§è‡•§`, 'success');
            renderApp();
        } else {
            qs('#auth-error').textContent = `‡§ó‡§≤‡§§ Gmail ID ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§`;
            qs('#auth-error').classList.remove('hidden');
        }
    }

    function handleSignup(email, password, username, mobile) {
        if (allUsersCache.find(u => u.email === email)) {
            qs('#auth-error').textContent = `‡§Ø‡§π Gmail ID ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡•§`;
            qs('#auth-error').classList.remove('hidden');
            return;
        }

        promptMobileVerification().then(() => {
            const newUser = {
                uid: `user_${Date.now()}`,
                username,
                email,
                password,
                mobile,
                bio: 'Hey there! I am new to 1 SIDE LüíóVEüòò.',
                photoURL: '',
                isPremium: false,
                isPublic: true,
                xp: 0,
                followers: [],
                following: [],
                chatTheme: '#ff3864',
                chatBackground: '',
                createdAt: Date.now()
            };
            allUsersCache.push(newUser);
            saveAllUsers(allUsersCache);
            currentUserId = newUser.uid;
            localStorage.setItem('currentUserId', currentUserId);
            currentUserData = newUser;
            showCustomAlert('‡§∏‡§´‡§≤‡§§‡§æ', `‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§∏‡§´‡§≤!`, 'success');
            renderApp();
        });
    }

    function promptMobileVerification() {
        return new Promise((resolve) => {
            const modal = createModal('‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§µ‡•á‡§∞‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§®', `
                <p class="mb-4 text-gray-600">‡§Ü‡§™‡§ï‡•á ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ 4 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ (‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§∂‡§® ‡§ï‡•ã‡§°: <span class="font-bold text-pink-600">0123</span>)</p>
                <input type="text" id="verification-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 text-center text-lg" maxlength="4" placeholder="XXXX">
                <p id="code-error" class="text-red-500 text-sm mt-2 hidden">‡§ó‡§≤‡§§ ‡§ï‡•ã‡§°‡•§</p>
                <button id="verify-btn" class="w-full mt-4 py-2 px-4 rounded-lg shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700">‡§µ‡•á‡§∞‡•Ä‡§´‡§æ‡§à ‡§ï‡§∞‡•á‡§Ç</button>
            `);

            qs('#verify-btn').addEventListener('click', () => {
                const code = qs('#verification-code').value;
                if (code === '0123') {
                    closeModal();
                    resolve();
                } else {
                    qs('#code-error').classList.remove('hidden');
                }
            });
        });
    }

    function handleLogout() {
        currentUserId = null;
        localStorage.removeItem('currentUserId');
        currentUserData = null;
        renderApp();
    }

    const renderAuthView = (mode) => {
        const container = qs('#auth-view');
        container.classList.remove('hidden');
        qs('#app-content').classList.add('hidden');
        
        container.innerHTML = `
            <div class="w-full max-w-xs p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-3xl font-extrabold text-center text-pink-600 mb-6">
                    ${mode === 'login' ? '‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç' : '‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç'}
                </h2>
                <div class="p-3 bg-yellow-50 text-yellow-800 rounded-lg text-sm mb-4">
                    <p class="font-bold">üîë ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§≤‡•â‡§ó‡§ø‡§®:</p>
                    <p>Gmail ID: <span class="font-mono">priya@app.com</span></p>
                    <p>‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°: <span class="font-mono">password</span></p>
                </div>
                <form id="${mode}-form">
                    ${mode === 'signup' ? `
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700" for="username">‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ</label>
                            <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700" for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="text" id="mobile" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                    ` : ''}
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700" for="email">Gmail ID</label>
                        <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required value="${mode === 'login' ? 'priya@app.com' : ''}">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700" for="password">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required value="${mode === 'login' ? 'password' : ''}">
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" class="w-full mt-4 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        ${mode === 'login' ? '‡§≤‡•â‡§ó ‡§á‡§®' : '‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç'}
                    </button>
                </form>
                <button id="switch-auth-mode" class="w-full mt-4 text-sm text-pink-600 hover:text-pink-800">
                    ${mode === 'login' ? '‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç' : '‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§π‡•à? ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç'}
                </button>
                <button id="reset-data-btn" class="w-full mt-2 text-xs text-gray-500 hover:text-red-500">
                    ‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Local Storage)
                </button>
            </div>
        `;

        qs(`#${mode}-form`).addEventListener('submit', (e) => {
            e.preventDefault();
            const email = qs('#email').value;
            const password = qs('#password').value;
            const errorElement = qs('#auth-error');
            errorElement.classList.add('hidden');

            if (mode === 'signup') {
                handleSignup(email, password, qs('#username').value, qs('#mobile').value);
            } else {
                handleLogin(email, password);
            }
        });

        qs('#switch-auth-mode').addEventListener('click', () => {
            renderAuthView(mode === 'login' ? 'signup' : 'login');
        });
        
        qs('#reset-data-btn').addEventListener('click', () => {
             if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö‡§Æ‡•Å‡§ö ‡§∏‡§æ‡§∞‡§æ ‡§≤‡•ã‡§ï‡§≤ ‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§á‡§∏‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§î‡§∞ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§Æ‡§ø‡§ü ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§')) {
                 clearLocalStorageAndReset();
             }
        });
    }

    const renderFeedView = () => {
        const posts = JSON.parse(localStorage.getItem('posts')) || [];
        const mainView = qs('#main-view');
        mainView.innerHTML = `<div class="p-4 space-y-6" id="posts-list"></div>`;

        qs('#header-actions').innerHTML = `
            <button id="open-post-modal" class="p-2 text-pink-600 hover:text-pink-800 rounded-full">
                ${lucide.createAIcon('PlusSquare', 'w-6 h-6').toSvg()}
            </button>
        `;
        qs('#open-post-modal').addEventListener('click', renderPostModal);

        const postsList = qs('#posts-list');
        if (posts.length === 0) {
            postsList.innerHTML = '<p class="text-center text-gray-500 p-8">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•ã‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§è‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç!</p>';
            return;
        }

        const sortedPosts = posts.sort((a, b) => b.createdAt - a.createdAt);

        sortedPosts.forEach(post => {
            const postUser = allUsersCache.find(u => u.uid === post.userId);
            if (!postUser) return;

            const isVisible = postUser.isPublic || (postUser.uid === currentUserId) || currentUserData.following.includes(postUser.uid);
            
            if (isVisible) {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                
                const { crown } = calculateLevelAndCrown(postUser.xp);
                const userLink = `<div class="flex items-center space-x-3 p-3 border-b">
                    <img src="${getAvatarUrl(postUser.photoURL)}" onerror="this.src='[https://placehold.co/50x50/fecaca/9f1239?text=Love](https://placehold.co/50x50/fecaca/9f1239?text=Love)';" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-gray-800">${postUser.username} ${crown !== 'No Crown' ? `<span class="text-xs text-yellow-500">${crown}</span>` : ''}</p>
                        <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleDateString('hi-IN')}</p>
                    </div>
                </div>`;

                const interactionBar = `<div class="p-3 flex items-center justify-between border-t">
                    <div class="flex space-x-4">
                        <button class="flex items-center space-x-1 text-gray-600 hover:text-pink-600 transition" data-action="like" data-post-id="${post.id}">
                            ${post.likes?.includes(currentUserId) ? lucide.createAIcon('Heart', 'w-5 h-5 fill-pink-600 stroke-pink-600').toSvg() : lucide.createAIcon('Heart', 'w-5 h-5').toSvg()}
                            <span class="text-sm">${post.likes?.length || 0}</span>
                        </button>
                        <button class="flex items-center space-x-1 text-gray-600 hover:text-pink-600 transition" data-action="comment" data-post-id="${post.id}">
                            ${lucide.createAIcon('MessageSquare', 'w-5 h-5').toSvg()}
                            <span class="text-sm">${post.comments?.length || 0}</span>
                        </button>
                        <button class="flex items-center space-x-1 text-gray-600 hover:text-pink-600 transition" data-action="share" data-post-id="${post.id}">
                            ${lucide.createAIcon('Share2', 'w-5 h-5').toSvg()}
                            <span class="text-sm">${post.shares || 0}</span>
                        </button>
                    </div>
                </div>`;

                postElement.innerHTML = `
                    ${userL
